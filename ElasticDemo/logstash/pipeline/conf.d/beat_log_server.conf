input {
  beats {
    port => 5044
  }
}

filter {
  mutate {
    add_field => { "logstash_processed" => "true" }
  }
}
 
output {
  # 發送到 Elasticsearch
  elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "logs-%{+YYYY.MM.dd}"
    }
  
  # 將包含 ERROR 的日誌轉發到 Slack（需設定環境變數 SLACK_WEBHOOK_URL）
  if [message] =~ /(?i)\berror\b/ or [log][level] =~ /(?i)^error$/ {
    http {
      url => "${SLACK_WEBHOOK_URL}"
      http_method => "post"
      format => "json"
      content_type => "application/json"
      mapping => { 
        "text" => "[log-server ERROR] %{message}" 
      }
      retry_non_idempotent => true
    }
  }

  # 輸出到標準輸出（用於調試）
  stdout { 
    codec => rubydebug {
      metadata => true
    }
  }
}

